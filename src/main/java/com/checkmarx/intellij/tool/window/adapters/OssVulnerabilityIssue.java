package com.checkmarx.intellij.tool.window.adapters;

import com.checkmarx.ast.oss.Package;
import com.checkmarx.ast.oss.Location;
import com.checkmarx.ast.oss.Vulnerability;

import java.util.ArrayList;
import java.util.List;

public class OssVulnerabilityIssue implements VulnerabilityIssue {

    private final String filePath;
    private final String packageManager;
    private final String packageName;
    private final String packageVersion;
    private final int line;
    private final String status;
    private final String severity;
    private final String cve;
    private final String description;

    public OssVulnerabilityIssue(String filePath, String packageManager, String packageName, String packageVersion,
                                 int line, String status, String severity, String cve,
                                 String description) {
        this.filePath = filePath;
        this.packageManager = packageManager;
        this.packageName = packageName;
        this.packageVersion = packageVersion;
        this.line = line;
        this.status = status;
        this.severity = severity;
        this.cve = cve;
        this.description = description;
    }

    @Override
    public String getFilePath() {
        return filePath;
    }

    public String getPackageManager() {
        return packageManager;
    }

    @Override
    public int getLine() {
        return line;
    }

    @Override
    public String getSeverity() {
        // Vulnerability severity takes precedence; fallback to package status
        return severity != null ? severity : status;
    }

    @Override
    public String getTitle() {
        return packageName;
    }

    @Override
    public String getDescription() {
        return description != null ? description : "";
    }

    @Override
    public String getRemediationAdvise() {
        return "";
    }

    @Override
    public String getPackageVersion() {
        return packageVersion;
    }

    @Override
    public String getCve() {
        return cve;
    }

    /**
     * Factory method to convert from your Package POJO to OssVulnerabilityIssue list
     */
    public static List<OssVulnerabilityIssue> fromPackagePojo(Package pkg) {
        List<OssVulnerabilityIssue> issues = new ArrayList<>();
        if(!pkg.getStatus().equals("OK")) {
            if (pkg.getVulnerabilities() != null && !pkg.getVulnerabilities().isEmpty()) {
                for (Vulnerability vuln : pkg.getVulnerabilities()) {
                    for (Object locObj : pkg.getLocations()) {
                        Location loc = (Location) locObj;
                        issues.add(new OssVulnerabilityIssue(
                                pkg.getFilePath(),
                                pkg.getPackageManager(),
                                pkg.getPackageName(),
                                pkg.getPackageVersion(),
                                loc.getLine(),
                                pkg.getStatus(),
                                vuln.getSeverity(),
                                vuln.getCve(),
                                vuln.getDescription()
                        ));
                    }
                }
            } else {
                for (Object locObj : pkg.getLocations()) {
                    Location loc = (Location) locObj;
                    issues.add(new OssVulnerabilityIssue(
                            pkg.getFilePath(),
                            pkg.getPackageManager(),
                            pkg.getPackageName(),
                            pkg.getPackageVersion(),
                            loc.getLine(),
                            pkg.getStatus(),
                            null,
                            null,
                            null
                    ));
                }
            }
        }
        return issues;
    }
}
