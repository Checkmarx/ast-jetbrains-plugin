package com.checkmarx.intellij.tool.window;

import com.checkmarx.intellij.Constants;
import com.checkmarx.intellij.service.ProblemHolderService;
import com.checkmarx.intellij.tool.window.adapters.VulnerabilityIssue;
import com.intellij.icons.AllIcons;
import com.intellij.openapi.Disposable;
import com.intellij.openapi.editor.*;
import com.intellij.openapi.fileEditor.FileEditorManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.SimpleToolWindowPanel;
import com.intellij.openapi.vfs.LocalFileSystem;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.ui.treeStructure.SimpleTree;
import javax.swing.*;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreePath;
import java.awt.*;
import java.awt.datatransfer.StringSelection;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

public class VulnerabilityToolWindow extends SimpleToolWindowPanel implements Disposable {

    private final Project project;
    private final SimpleTree tree;
    private final DefaultMutableTreeNode rootNode;
    private static Map<String, Icon> severityToIcon;

    public VulnerabilityToolWindow(Project project) {
        super(true, true);
        this.project = project;
        this.tree = new SimpleTree();
        this.rootNode = new DefaultMutableTreeNode();
        tree.setModel(new javax.swing.tree.DefaultTreeModel(rootNode));
        tree.setCellRenderer(new IssueTreeRenderer());
        tree.setRootVisible(false);

        add(new JScrollPane(tree), BorderLayout.CENTER);

        initSeverityIcons();

        tree.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                if (e.getClickCount() == 2) navigateToSelectedIssue();
            }

            @Override
            public void mousePressed(MouseEvent e) {
                handleRightClick(e);
            }

            @Override
            public void mouseReleased(MouseEvent e) {
                handleRightClick(e);
            }
        });

        // Subscribe to updates
        project.getMessageBus().connect(this)
                .subscribe(ProblemHolderService.ISSUE_TOPIC, new ProblemHolderService.IssueListener() {
                    @Override
                    public void onIssuesUpdated(Map<String, List<VulnerabilityIssue>> issues) {
                        SwingUtilities.invokeLater(() -> refreshTree(issues));
                    }
                });
    }

    private void initSeverityIcons() {
        severityToIcon = new HashMap<>();
        severityToIcon.put(Constants.ASCA_CRITICAL_SEVERITY, AllIcons.General.Error);
        severityToIcon.put(Constants.ASCA_HIGH_SEVERITY, AllIcons.General.Error);
        severityToIcon.put(Constants.ASCA_MEDIUM_SEVERITY, AllIcons.General.Warning);
        severityToIcon.put(Constants.ASCA_LOW_SEVERITY, AllIcons.General.Information);
    }

    public void refreshTree(Map<String, List<VulnerabilityIssue>> issues) {
        // Save expanded file node names (file paths)
        Set<String> expandedPathsSet = new java.util.HashSet<>();

        int rowCount = tree.getRowCount();
        for (int i = 0; i < rowCount; i++) {
            TreePath path = tree.getPathForRow(i);
            if (path != null && tree.isExpanded(path)) {
                Object lastNode = path.getLastPathComponent();
                if (lastNode instanceof DefaultMutableTreeNode) {
                    DefaultMutableTreeNode node = (DefaultMutableTreeNode) lastNode;
                    Object userObject = node.getUserObject();
                    if (userObject instanceof String) {  // file path nodes
                        expandedPathsSet.add((String) userObject);
                    }
                }
            }
        }
        // Clear and rebuild tree
        rootNode.removeAllChildren();
        for (Map.Entry<String, List<VulnerabilityIssue>> entry : issues.entrySet()) {
            String filePath = entry.getKey();
            List<VulnerabilityIssue> scanDetails = entry.getValue();

            DefaultMutableTreeNode fileNode = new DefaultMutableTreeNode(filePath);
            for (VulnerabilityIssue detail : scanDetails) {
                fileNode.add(new DefaultMutableTreeNode(new ScanDetailWithPath(detail, filePath)));
            }
            rootNode.add(fileNode);
        }
        ((DefaultTreeModel) tree.getModel()).reload();

        // Expand nodes by file path after reload
        SwingUtilities.invokeLater(() -> {
            for (int i = 0; i < tree.getRowCount(); i++) {
                TreePath path = tree.getPathForRow(i);
                if (path != null) {
                    Object lastNode = path.getLastPathComponent();
                    if (lastNode instanceof DefaultMutableTreeNode) {
                        DefaultMutableTreeNode node = (DefaultMutableTreeNode) lastNode;
                        Object userObject = node.getUserObject();
                        if (userObject instanceof String && expandedPathsSet.contains(userObject)) {
                            tree.expandPath(path);
                        }
                    }
                }
            }
        });
    }

    private void navigateToSelectedIssue() {
        Object selected = tree.getLastSelectedPathComponent();
        if (!(selected instanceof DefaultMutableTreeNode)) return;
        DefaultMutableTreeNode node = (DefaultMutableTreeNode) selected;
        Object userObj = node.getUserObject();
        if (!(userObj instanceof ScanDetailWithPath)) return;

        ScanDetailWithPath detailWithPath = (ScanDetailWithPath) userObj;
        VulnerabilityIssue detail = detailWithPath.detail;
        String filePath = detailWithPath.filePath;
        int lineNumber = detail.getLine();

        VirtualFile virtualFile = LocalFileSystem.getInstance().findFileByPath(filePath);
        if (virtualFile == null) return;

        FileEditorManager editorManager = FileEditorManager.getInstance(project);
        editorManager.openFile(virtualFile, true);
        Editor editor = editorManager.getSelectedTextEditor();
        if (editor != null) {
            Document document = editor.getDocument();
            LogicalPosition logicalPosition = new LogicalPosition(lineNumber - 1, 0);
            editor.getCaretModel().moveToLogicalPosition(logicalPosition);
            editor.getScrollingModel().scrollTo(logicalPosition, ScrollType.CENTER);

        }
    }

    private void handleRightClick(MouseEvent e) {
        if (!e.isPopupTrigger()) return;

        int row = tree.getClosestRowForLocation(e.getX(), e.getY());
        tree.setSelectionRow(row);
        Object selected = tree.getLastSelectedPathComponent();
        if (!(selected instanceof DefaultMutableTreeNode)) return;
        DefaultMutableTreeNode node = (DefaultMutableTreeNode) selected;
        Object userObj = node.getUserObject();
        if (!(userObj instanceof ScanDetailWithPath)) return;

        VulnerabilityIssue detail = ((ScanDetailWithPath) userObj).detail;
        JPopupMenu popup = new JPopupMenu();
        JMenuItem copyFix = new JMenuItem("Copy Fix");
        copyFix.addActionListener(ev -> {
            String fixText = detail.getRemediationAdvise();
            Toolkit.getDefaultToolkit().getSystemClipboard()
                    .setContents(new StringSelection(fixText), null);
        });
        popup.add(copyFix);
        popup.show(tree, e.getX(), e.getY());
    }

    private static class IssueTreeRenderer extends DefaultTreeCellRenderer {
        @Override
        public Component getTreeCellRendererComponent(JTree tree, Object value,
                                                      boolean sel, boolean expanded,
                                                      boolean leaf, int row,
                                                      boolean hasFocus) {
            JLabel label = (JLabel) super.getTreeCellRendererComponent(tree, value, sel, expanded, leaf, row, hasFocus);

            if (value instanceof DefaultMutableTreeNode) {
                DefaultMutableTreeNode node = (DefaultMutableTreeNode) value;
                Object obj = node.getUserObject();

                if (obj instanceof ScanDetailWithPath) {
                    VulnerabilityIssue detail = ((ScanDetailWithPath) obj).detail;
                    label.setText(detail.getCve() +" - "+ detail.getPackageVersion() +" (line " + detail.getLine() + ")");
                    label.setIcon(severityToIcon.getOrDefault(detail.getSeverity(), null));
                } else if (obj instanceof String) {
                    String filePath = (String) obj;
                    label.setText((String) obj);
                    label.setIcon(null);
                }
            } else {
                label.setIcon(null);
            }
            return label;
        }
    }

    @Override
    public void dispose() {
        // Cleanup if needed
    }

    public static class ScanDetailWithPath {
        public final VulnerabilityIssue detail;
        public final String filePath;

        public ScanDetailWithPath(VulnerabilityIssue detail, String filePath) {
            this.detail = detail;
            this.filePath = filePath;
        }
    }

}
