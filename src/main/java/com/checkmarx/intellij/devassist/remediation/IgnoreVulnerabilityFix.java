package com.checkmarx.intellij.devassist.remediation;

import com.checkmarx.intellij.CxIcons;
import com.checkmarx.intellij.Utils;
import com.checkmarx.intellij.devassist.ignore.IgnoreManager;
import com.checkmarx.intellij.devassist.model.ScanIssue;
import com.checkmarx.intellij.devassist.utils.DevAssistConstants;
import com.intellij.codeInspection.LocalQuickFix;
import com.intellij.codeInspection.ProblemDescriptor;
import com.intellij.codeInspection.util.IntentionFamilyName;
import com.intellij.openapi.diagnostic.Logger;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.util.Iconable;
import org.jetbrains.annotations.NotNull;

import javax.swing.*;

import static com.checkmarx.intellij.devassist.utils.DevAssistConstants.QUICK_FIX;

/**
 * Represents a quick fix action that allows users to ignore a specific scan issue identified during a security scan.
 * This class is part of the LocalQuickFix interface and provides functionality to mark a vulnerability as ignored
 * within the context of the problem descriptor and the associated project.
 */
public class IgnoreVulnerabilityFix implements LocalQuickFix, Iconable {

    private static final Logger LOGGER = Utils.getLogger(IgnoreVulnerabilityFix.class);

    @SafeFieldForPreview
    private final ScanIssue scanIssue;

    /**
     * Constructs an IgnoreVulnerabilityFix instance to provide an action for ignoring a specific scan issue.
     * This fix allows users to mark a vulnerability as ignored within the context of a scan.
     *
     * @param scanIssue the scan issue that this fix targets; contains details such as severity, title, description,
     *                  file path, and associated vulnerabilities
     */
    public IgnoreVulnerabilityFix(ScanIssue scanIssue) {
        this.scanIssue = scanIssue;
    }

    /**
     * Returns the family name of this quick fix.
     * The family name is used to group similar quick fixes together and is displayed
     * in the "Apply Fix" popup when multiple quick fixes are available.
     *
     * @return a non-null string representing the family name, which categorizes this quick fix
     */
    @Override
    public @IntentionFamilyName @NotNull String getFamilyName() {
        return DevAssistConstants.IGNORE_THIS_VULNERABILITY_FIX_NAME;
    }

    /**
     * Returns the icon representing this quick fix.
     */
    @Override
    public Icon getIcon(int flags) {
        return CxIcons.STAR_ACTION;
    }

    /**
     * Applies a fix for a specified problem descriptor within a project.
     * This method is implemented as part of the LocalQuickFix interface and performs
     * the action associated with resolving or addressing the scan issue represented
     * by the ProblemDescriptor.
     *
     * @param project    the project in which the fix is to be applied; must not be null
     * @param descriptor the descriptor representing the problem to be fixed; must not be null
     */
    @Override
    public void applyFix(@NotNull Project project, @NotNull ProblemDescriptor descriptor) {
        LOGGER.info("applyFix called.." + getFamilyName() + " " + scanIssue.getTitle());
        IgnoreManager.getInstance(project).addIgnoredEntry(scanIssue, QUICK_FIX);
    }

}
